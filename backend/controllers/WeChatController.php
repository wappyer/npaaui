<?php
/**
 * Created by PhpStorm.
 * User: alice
 * Date: 2017/11/30
 * Time: ä¸‹åˆ4:12
 */

namespace backend\controllers;


use common\base\BaseController;
use common\base\NoCsrf;
use common\form\WecharUserForm;

class WeChatController extends BaseController
{
    private $postXml;   //æ¥æ”¶å¾®ä¿¡ä¼ å…¥çš„xml

    private $postObj;   //æ¥æ”¶xmlè½¬æ¢æˆçš„å¯¹è±¡

    private $myId;  //å¾®ä¿¡å…¬ä¼—å·ID    gh_24696e54a9b1

    private $openId; //è®¿é—®äººopenID    og8XAwhR970_A1BkxAt7uB-3LT8Y

    private $createTime;  //è¯·æ±‚å»ºç«‹æ—¶é—´

    private $msgType;   //æ¶ˆæ¯ç±»å‹

    private $encrypt;

    private $event; //äº‹ä»¶ç±»å‹

    private $eventKey;

    private $content;

    private $msgId;

    public function behaviors()
    {
        return [
            'verbs' => [
                'class' => NoCsrf::className(),
                'controller' => $this,
                'actions' => [
                    'index',
                ],
            ],
        ];
    }

    public function beforeAction($action)
    {
        //è·å¾—å‚æ•° signature nonce token timestamp echostr
        $nonce     = $_GET['nonce'];
        $token     = 'alice';
        $timestamp = $_GET['timestamp'];
        $signature = $_GET['signature'];
        //å½¢æˆæ•°ç»„ï¼Œç„¶åæŒ‰å­—å…¸åºæ’åº
        $array = array($nonce, $timestamp, $token);
        sort($array);
        //æ‹¼æ¥æˆå­—ç¬¦ä¸²,sha1åŠ å¯† ï¼Œç„¶åä¸signatureè¿›è¡Œæ ¡éªŒ
        $str = sha1( implode( $array ) );
        if( $str  == $signature && isset($_GET['echostr']) ){
            //ç¬¬ä¸€æ¬¡æ¥å…¥weixin apiæ¥å£çš„æ—¶å€™
            echo  $_GET['echostr'];
            exit;
        }else{
            /*<xml>
                <ToUserName><![CDATA[gh_24696e54a9b1]]></ToUserName>
                <FromUserName><![CDATA[og8XAwhR970_A1BkxAt7uB-3LT8Y]]></FromUserName>
                <CreateTime>1512204708</CreateTime>
                <MsgType><![CDATA[event]]></MsgType>
                <Event><![CDATA[subscribe]]></Event>
                <EventKey><![CDATA[]]></EventKey>
                <Encrypt><![CDATA[UoMUMP3WKooFFFz6iWF85R/8QL7wXyQb3HWclamiMOJb2gIZHWrqQS8E4hd//eqhqh9m+rSE72w5UlR3uYsHI5M9aXqNT0NyoEEgb1krnqYih1EP05HlfyQjMOcQ7YUB3icYZ91CmwiKNl8KmMWuQhP8xu3MSxK+8tN9jU0mfL0GrVCisky936Qaerw8dh60AcfMXZEEqmX4q3J7dNVj5c3Lnj7YoERvKEZ6NxQq/iUrODwWkbdFT7iraRioU7VNzPPS/dUF1c0t7CfeENmcDdjHGcqROre/mJzQXvv9YzeAHI1y7C/Bg63YLBunSo5mZSSwsqEQpHz1KPY05FrjIDjlDA+tJbDxmafIXf4NqoT4S48+IjLNSa1VZjWWzu2uGcmOnzo3x5Zxm3j/zHgaZRg7CuP8F3/rXsGTC3xSBdE=]]></Encrypt>
            </xml>*/
            /*<xml>
                <ToUserName><![CDATA[gh_24696e54a9b1]]></ToUserName>
                <FromUserName><![CDATA[og8XAwhR970_A1BkxAt7uB-3LT8Y]]></FromUserName>
                <CreateTime>1512309591</CreateTime>
                <MsgType><![CDATA[text]]></MsgType>
                <Content><![CDATA[2396]]></Content>
                <MsgId>6495320235194850802</MsgId>
                <Encrypt><![CDATA[wElOgQyeKTx/raG0Y+wSnFlazE5EEfXo//0H8sTkP+SFry7jR6BUxDaC+OMCx2bn7NYct4gXPu8PZi1rPnRXQfa4z282IxfOFlcBfplAfwCAv1eru7c7AH+cBTrFkgcu5CSP81mlhBAfoDC3zLZDr5zEY3KiGqxntymHSQ9ZaDW2YZcVqXWB4MLzlrjzuZfpLBhxCesBNdM+XRLcKf2h7m0DTR3fBE+4YtwRnlYPlYhTQrRtkMq2SecZvcJ5tRjeEJ7HOtez0Ja8tcwfd0Z8SI0Iay5hHE2gkPrIYAyPioeT5r7lEtWixwSd83oK7i6G0mg+LMz2+kq7MIx0tTJVROvQj3fU92c7Y7kpKmgE2O4BHaEjODq1xDJB7Tq7T0B7QOFe6ORZ2WUaeIJQUAFlp4q01mOu30Mjr3kc7Suo+u4=]]></Encrypt>
            </xml>*/
            //1.è·å–åˆ°å¾®ä¿¡æ¨é€è¿‡æ¥postæ•°æ®
            $this->postXml = file_get_contents("php://input");
            error_log(print_r($this->postXml,1));
            //2.å¤„ç†æ¶ˆæ¯ç±»å‹ï¼Œå¹¶è®¾ç½®å›å¤ç±»å‹å’Œå†…å®¹
            $this->postObj = simplexml_load_string($this->postXml);

            $this->myId = $this->postObj->ToUserName;
            $this->openId = $this->postObj->FromUserName;
            $this->createTime = $this->postObj->CreateTime;
            $this->msgType = strtolower($this->postObj->MsgType);
            $this->encrypt = $this->postObj->Encrypt;
            //äº‹ä»¶
            $this->event = strtolower($this->postObj->Event);
            $this->eventKey = $this->postObj->EventKey;
            //æ–‡æœ¬æ¶ˆæ¯
            $this->content = $this->postObj->Content;
            $this->msgId = $this->postObj->MsgId;

            return parent::beforeAction($action); // TODO: Change the autogenerated stub
        }
    }

    public function actionIndex(){
        error_log('index');
        if ($this->msgType == 'event' && $this->event == 'subscribe') {
            //äº‹ä»¶ï¼Œå¹¶ä¸”æ˜¯å…³æ³¨äº‹ä»¶
            $this->subscribe();
        }
        if ($this->msgType == 'text') {
            //æ–‡æœ¬æ¶ˆæ¯
            $this->msg();
        }
    }

    //å…³æ³¨äº‹ä»¶å›å¤
    public function subscribe()
    {
        error_log('subscribe');
        //è®°å½•å…³æ³¨äººä¿¡æ¯
        WecharUserForm::createWechatUser($this->openId, $this->createTime);
        $msgType = 'text';
        $content = 'æ¬¢è¿å…³æ³¨ï¼Œæœ›è¾°ç ‚ä¹‹è¨€ï¼Œäºå°”å¿ƒæœ‰æˆšæˆšç„‰ã€‚';
        $this->response($msgType, $content);
    }

    //æ¶ˆæ¯å›å¤
    public function msg()
    {
        error_log('msg');
        $message = explode(' ', $this->content);
        switch ($message[0]) {
            case 'sy' :
                //æ”¶ç›Šè®¡ç®—
                $content = WecharUserForm::profit($message);
                break;
            case 'tq' :
                $content = WecharUserForm::weather($message);
                break;
            default :
                $content = 'ğŸ‘æ„Ÿè°¢æ‚¨çš„ç•™è¨€ï¼Œè¾°ç ‚æ­£åœ¨æ²‰æ€ï¼Œä¼šå°½å¿«å›å¤æ‚¨ï¼';
        }
        $msgType = 'text';
        $this->response($msgType, $content);

    }

    //æ„å»ºå“åº”æ¶ˆæ¯æ ¼å¼
    public function response($msgType, $content)
    {
        error_log('response');
        //å›å¤ç”¨æˆ·æ¶ˆæ¯(çº¯æ–‡æœ¬æ ¼å¼)
        $toUser = $this->openId;
        $fromUser = $this->myId;
        $time = time();
        $template = "<xml>
                    <ToUserName><![CDATA[%s]]></ToUserName>
                    <FromUserName><![CDATA[%s]]></FromUserName>
                    <CreateTime>%s</CreateTime>
                    <MsgType><![CDATA[%s]]></MsgType>
                    <Content><![CDATA[%s]]></Content>
                    </xml>";
        $info = sprintf($template, $toUser, $fromUser, $time, $msgType, $content);
        echo $info;
    }
}